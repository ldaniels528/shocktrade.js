/**
 * Recent Symbols Service
 * @author lawrence.daniels@gmail.com
 */
angular
	.module('shocktrade')
	.factory('RecentSymbols', function($http, $log, $q, HeldSecurities, FavoriteSymbols, MySession) {
		
	var service = {
		symbols: [],
		quotes : []
	};
	
	service.getLast = function() {
		var symbols = service.symbols;
		return (symbols.length > 0) ? symbols[symbols.length-1] : "AMZN";
	};

	service.add = function(symbol) {
		var index = indexOf(symbol);
		if( index === -1) {
			// get the user ID
			var id = MySession.userProfile._id ? MySession.userProfile._id.$oid : null;
			
			// add the symbol to the profile
			if(id !== null) {
				$http({ method:'PUT', url:'/api/profile/' + id + '/recent/' + symbol }).then(function(response) {
					service.lastSymbol = symbol;
					service.symbols.unshift(symbol);
					loadQuotes();
				});
			}
		}
	}
	
	service.isEmpty = function() {
		return service.symbols.length === 0;
	}

	service.remove = function(symbol) {
		var index = indexOf(symbol);
		if( index != -1) {
			// get the user ID
			var id = MySession.userProfile._id.$oid;
			
			// remove the symbol from the profile
			$http({ method:'DELETE', url:'/api/profile/' + id + '/recent/' + symbol }).then(function(response) {
				service.symbols.splice(index, 1);
				loadQuotes();
			});
		}
	}
	
	service.setSymbols = function(symbols) {
		service.symbols = symbols;
		loadQuotes();
	}
	
	service.getQuotes = function() {
		return service.quotes;
	}
	
	function indexOf(symbol) {
		for(var n = 0; n < service.symbols.length; n++) {
			if( symbol == service.symbols[n]) {
				return n;
			}
		}
		return -1;
	}
	
	function loadQuotes() {
		return $http({
			method : 'POST',
			url : '/api/quotes/list',
			data : angular.toJson(service.symbols)
		}).then(function(response) {
			var quotes = response.data;
			for(var n = 0; n < quotes.length; n++) {
				quotes[n].favorite = FavoriteSymbols.isFavorite(quotes[n].symbol);
				quotes[n].held = HeldSecurities.isHeld(quotes[n].symbol);
			}
			service.quotes = quotes;
			return service.quotes;
		});
	}
	
	// pre-load the quotes
	loadQuotes().then(function(data) {
		//console.log("Loaded quotes for " + JSON.stringify(service.symbols));
		//console.log("Quotes = " + JSON.stringify(data, null , '\t'));
	});
	
	return service;
});