/**
 * Play Controller
 * @author lawrence.daniels@gmail.com
 */
angular
    .module('shocktrade')
    .controller('PlayCtrl', ['$scope', '$location', '$log', '$modal', 'MySession', 'ContestService', 'Errors', 'NewGameDialog', 'QuoteService',
        function ($scope, $location, $log, $modal, MySession, ContestService, Errors, NewGameDialog, QuoteService) {
            // setup UI variables
            $scope.statusBar = "";
            $scope.selection = {
                exposure: "sector",
                performance: "gains"
            };

            // setup contest variables
            $scope.contestId = "";
            $scope.contest = null;
            $scope.participant = {};
            $scope.orderChoice = "active";
            $scope.myContests = [];
            $scope.searchMyGame = "";
            $scope.gameType = "NORMAL";

            // define the games types
            $scope.GameTypes = [
                {id: "NORMAL", value: "Normal"},
                {id: "PRIVATE", value: "Private"}
            ];

            // search variables
            $scope.searchOptions = {
                activeOnly: true,
                available: false,
                perksAllowed: false,
                friendsOnly: false,
                acquaintances: false,
                levelCap: "1",
                levelCapAllowed: false
            };
            $scope.searchResults = [];

            // setup the tabs
            $scope.playTabs = [{
                "name": "Games",
                "imageURL": "/assets/images/buttons/search.png",
                "path": "/assets/views/play/search/search.htm",
                "url": "/play/search",
                "active": false,
                "lockable": false,
                "disabled": false,
            }, {
                "name": "Lobby",
                "imageURL": "/assets/images/objects/reward.png",
                "path": "/assets/views/play/rankings/rankings.htm",
                "url": "/play/rankings",
                "active": false,
                "lockable": false,
                "disabled": false
            }, {
                "name": "Lounge",
                "imageURL": "/assets/images/objects/friend_header.gif",
                "path": "/assets/views/play/lounge/lounge.htm",
                "url": "/play/lounge",
                "active": false,
                "lockable": true,
                "disabled": false
            }, {
                "name": "Portfolio",
                "imageURL": "/assets/images/objects/portfolio_header.png",
                "path": "/assets/views/play/portfolio/portfolio.htm",
                "url": "/play/portfolio",
                "active": false,
                "lockable": true,
                "disabled": false
            }, {
                "name": "Awards",
                "path": "/assets/views/play/awards/awards.htm",
                "imageURL": "/assets/images/objects/award.gif",
                "url": "/play/awards",
                "active": false,
                "lockable": false,
                "disabled": false
            }, {
                "name": "Perks",
                "path": "/assets/views/play/perks/perks.htm",
                "imageURL": "/assets/images/objects/gift.png",
                "url": "/play/perks",
                "active": false,
                "lockable": false,
                "disabled": false
            }, {
                "name": "Statistics",
                "path": "/assets/views/play/statistics/statistics.htm",
                "imageURL": "/assets/images/objects/stats.gif",
                "url": "/play/statistics",
                "active": false,
                "lockable": false,
                "disabled": false
            }];

            $scope.changePlayTab = function (tabIndex) {
                console.log("Changing location to " + $scope.playTabs[tabIndex].url);
                $location.path($scope.playTabs[tabIndex].url);
                return true;
            }

            $scope.setPlayActiveTab = function (tabIndex) {
                console.log("Setting Play active tab to #" + tabIndex + " (" + $scope.playTabs[tabIndex].url + ")");

                // make all of the tabs inactive
                for (var n = 0; n < $scope.playTabs.length; n++) {
                    $scope.playTabs[n].active = false;
                }
                $scope.playTabs[tabIndex].active = true;
            }

            $scope.getCashAvailable = function (participant) {
                return (participant.fundsAvailable || 0) - $scope.getTotalBuyOrders(participant);
            }

            $scope.asOfDate = function (participant) {
                return participant.lastTradeTime ? participant.lastTradeTime : new Date();
            }

            $scope.getAvailableCount = function () {
                var count = 0;
                $scope.searchResults.forEach(function (r) {
                    if (r.status == 'ACTIVE') count++;
                });
                return count;
            };

            $scope.getTotalEquity = function (participant) {
                return $scope.getTotalInvestment(participant) + (participant.fundsAvailable || 0);
            };

            $scope.getTotalInvestment = function (participant) {
                var positions = participant.positions || [];
                var total = 0;
                for (var n = 0; n < positions.length; n++) {
                    var p = positions[n];
                    total += p.price * p.quantity + p.commission;
                }
                return total;
            };

            $scope.getTotalBuyOrders = function (participant) {
                var orders = participant.orders || [];
                var total = 0;
                for (var n = 0; n < orders.length; n++) {
                    var o = orders[n];
                    if (o.orderType == 'BUY') {
                        total += o.limitPrice * o.quantity + o.commision1;
                    }
                }
                return total;
            };

            $scope.getTotalSellOrders = function (participant) {
                var orders = participant.orders || [];
                var total = 0;
                for (var n = 0; n < orders.length; n++) {
                    var o = orders[n];
                    if (o.orderType == 'SELL') {
                        total += o.limitPrice * o.quantity + o.commision1;
                    }
                }
                return total;
            };

            $scope.getTotalOrders = function (participant) {
                return $scope.getTotalBuyOrders(participant) + $scope.getTotalSellOrders(participant);
            };

            $scope.sendChatMessage = function (message) {
                var userId = MySession.userProfile.name;
                ContestService
                    .sendChatMessage($scope.contestId, userId, message)
                    .then(
                    function (response) {
                        var contest = response.data;
                        $scope.contest.messages = contest.messages;
                    },
                    function (response) {
                        Errors.addMessage("Failed to send message (" + response.data + ")");
                    });
            };

            $scope.emoticons = [
                {"symbol": ":-)", "uri": "icon_smile.gif", "tooltip": "Smile"},
                {"symbol": ";-)", "uri": "icon_wink.gif", "tooltip": "Wink"},
                {"symbol": ":-D", "uri": "icon_biggrin.gif", "tooltip": "Big Smile"},
                {"symbol": ":->", "uri": "icon_razz.gif", "tooltip": "Razzed"},
                {"symbol": "B-)", "uri": "icon_cool.gif", "tooltip": "Cool"},
                {"symbol": "$-|", "uri": "icon_rolleyes.gif", "tooltip": "Roll Eyes"},
                {"symbol": "8-|", "uri": "icon_eek.gif", "tooltip": "Eek"},
                {"symbol": ":-/", "uri": "icon_confused.gif", "tooltip": "Confused"},
                {"symbol": "|-|", "uri": "icon_redface.gif", "tooltip": "Blush"},
                {"symbol": ":-(", "uri": "icon_sad.gif", "tooltip": "Sad"},
                {"symbol": ":'-(", "uri": "icon_cry.gif", "tooltip": "Cry"},
                {"symbol": ">:-(", "uri": "icon_evil.gif", "tooltip": "Enraged"},
                {"symbol": ":-))", "uri": "icon_mrgreen.gif", "tooltip": "Big Grin"},
                {"symbol": ":-|", "uri": "icon_neutral.gif", "tooltip": "Neutral"},
                {"symbol": ":-O", "uri": "icon_surprised.gif", "tooltip": "Surprised"},
                {"symbol": "(i)", "uri": "icon_idea.gif", "tooltip": "Idea"},
                {"symbol": "(!)", "uri": "icon_exclaim.gif", "tooltip": "Exclamation"},
                {"symbol": "(?)", "uri": "icon_question.gif", "tooltip": "Question"},
                {"symbol": "=>", "uri": "icon_arrow.gif", "tooltip": "Arrow"}];

            $scope.contestStatusClass = function (contest) {
                if (contest == null) return "";
                else if (contest.status == 'ACTIVE') return "positive";
                else if (contest.status == 'CLOSED') return "negative";
                else return "";
            };

            $scope.cancelOrder = function (contestId, playerName, orderId) {
                ContestService
                    .cancelOrder(contestId, playerName, orderId).then(
                    function (response) {
                        var participant = response.data;
                        $scope.participant = participant;
                        updateWithPricing(participant);
                    },
                    function (response) {
                        Errors.addMessage("Failed to cancel order");
                    });
            };

            $scope.deleteContest = function (contestId) {
                ContestService
                    .deleteContest(contestId).then(
                    function (response) {
                        $scope.participant = response.data;
                    },
                    function (response) {
                        Errors.addMessage("Failed to delete contest");
                    });
            };

            $scope.popupNewGameDialog = function () {
                NewGameDialog.popup($scope,
                    function () {
                        $log.info("Creating game...")
                    }, function () {
                        $log.info("Create game canceled.")
                    });
            };

            /**
             * Invite a player via pop-up dialog
             */
            $scope.invitePlayer = function () {

                var modalInstance = $modal.open({
                    templateUrl: 'invite_player.htm',
                    controller: 'PlayerInviteCtrl',
                    resolve: {
                        invites: function () {
                            return $scope.invites;
                        }
                    }
                });

                modalInstance.result.then(function (invites) {
                    $log.info("invites = " + angular.toJson(invites));
                    // $scope.invites = invites;
                }, function () {
                    $log.info('Modal dismissed at: ' + new Date());
                });
            };

            /**
             * Opens a new Order Entry Pop-up Dialog
             */
            $scope.orderFormPopup = function () {

                var modalInstance = $modal.open({
                    templateUrl: 'order_form.htm',
                    controller: 'OrderFormCtrl',
                    resolve: {
                        contest: function () {
                            return $scope.contest;
                        },
                        participant: function () {
                            return $scope.participant;
                        },
                        order: function () {
                            return $scope.order;
                        }
                    }
                });

                modalInstance.result.then(
                    function (participant) {
                        $scope.participant = participant;
                    },
                    function (err) {
                        $log.info('Modal dismissed at: ' + new Date());
                    });
            };

            $scope.quitGame = function () {
                return false;
            };

            $scope.changeArrow = function (change) {
                return change < 0 ? "stock_down.gif" : ( change > 0 ? "stock_up.gif" : "transparent.png" );
            };

            $scope.changeContest = function (contest) {
                if (contest != null) {
                    console.log("Changing contest to " + contest._id.$oid);
                    MySession.contestId = contest._id.$oid;
                }
            };

            function containsPlayer(participants, playerName) {
                return findPlayerByName(participants, playerName) != null;
            };

            function findPlayerByName(participants, playerName) {
                for (var n = 0; n < participants.length; n++) {
                    var participant = participants[n];
                    if (participant.name == playerName) {
                        return participant;
                    }
                }
                return null;
            };

            /**
             * Returns the contacts matching the given search term
             */
            $scope.getRegisteredFriends = function () {
                var fbFriends = MySession.fbFriends;
                /*
                 return fbFriends.filter(function(friend) {
                 return friend.profile;
                 });*/
                return fbFriends.slice(0, 20);
            };

            $scope.joinedPariticpant = function (contest, playerName) {
                return containsPlayer(contest, playerName);
            };

            $scope.getExposureChart = function (target) {
                $scope.getChart($scope.contestId, MySession.userProfile.name, $scope.selection.exposure, target);
            };

            $scope.getPerformanceChart = function (target) {
                $scope.getChart($scope.contestId, MySession.userProfile.name, $scope.selection.performance, target);
            };

            $scope.getChart = function (contestId, participantName, chartName, target) {
                if ((contestId && contestId != "") && (participantName && participantName != "")) {
                    // load the chart representing the securities
                    ContestService.getChart(contestId, participantName, chartName).then(
                        function (exposureData) {
                            // create the chart title & sub-title
                            var subTitle = capitalize(chartName);
                            var title = (chartName == "gains" || chartName == "losses") ? "Performance " + subTitle : subTitle + " Exposure";

                            // construct the chart
                            var exposure = new AmCharts.AmPieChart();
                            exposure.colors = ["#00dd00", "#ff00ff", "#00ffff", "#885500", "#0044ff", "#888800"];
                            exposure.addTitle(title, 12);
                            exposure.dataProvider = exposureData;
                            exposure.titleField = "title";
                            exposure.valueField = "value";
                            exposure.sequencedAnimation = true;
                            exposure.startEffect = "elastic";
                            exposure.startDuration = 2;
                            exposure.innerRadius = "30%";
                            exposure.labelRadius = 15;

                            // 3D chart
                            exposure.depth3D = 10;
                            exposure.angle = 15;
                            exposure.write(target);
                        },
                        function (err) {
                            console.log("Error: " + angular.toJson(err));
                        });
                }
            };

            function capitalize(value) {
                return value.charAt(0).toUpperCase() + value.substring(1);
            }

            $scope.starRating = function (gainLoss) {
                if (gainLoss > 250) return [1, 2, 3, 4, 5];
                else if (gainLoss > 100) return [1, 2, 3, 4];
                else if (gainLoss > 75) return [1, 2, 3];
                else if (gainLoss > 50) return [1, 2];
                else if (gainLoss > 25) return [1];
                else return [];
            };

            $scope.isMedalist = function (rank) {
                return rank == '1st' || rank == '2nd' || rank == '3rd';
            };

            $scope.gainLoss = function (tx) {
                var cost = (tx.pricePaid || 0) * tx.quantity;
                var gross = (tx.priceSold || 0) * tx.quantity;
                var comissions = (tx.commision1 || 0) + (tx.commision2 || 0) + (tx.commission || 0);
                var net = gross - (cost + comissions);
                return net != 0 ? ( net / cost) * 100 : 0;
            };

            $scope.loadContest = function (contestId) {
                if (contestId && contestId != "") {
                    // load the contest
                    ContestService.getContestByID(contestId)
                        .success(function (contest) {
                            $scope.contest = contest;
                            $scope.orderChoice = contest.status == 'ACTIVE' ? "active" : "history";
                            MySession.contestId = contestId;

                            // cache the player's name
                            var playerName = MySession.userProfile.name;

                            // find participant that represents the player
                            $scope.participant = lookupParticipantByName(playerName);

                            // load the enriched participant
                            updateWithRankings(playerName, contest);

                            // load the pricing for the participant's position
                            if ($scope.participant) {
                                updateWithPricing($scope.participant);
                            }
                        })
                        .error(function (xhr, status, error) {
                            $log.error("Error selecting feed: " + error.status);
                            toaster.pop('error', 'Error!', xhr.error);
                        });
                }
            };

            /**
             * Updates the contest with participant rankings
             */
            function updateWithRankings(playerName, contest) {
                ContestService.getRankings(contest._id.$oid).then(function (response) {
                    contest.rankings = response.data;

                    // capture the rankings for the current player
                    if ($scope.participant) {
                        for (var n = 0; n < contest.rankings.length; n++) {
                            var ranking = contest.rankings[n];
                            if (ranking.name == playerName) {
                                $scope.participant.gainLoss = ranking.gainLoss;
                                $scope.participant.rank = ranking.rank;
                            }
                        }
                    }

                    // add empty slots if the contest is active
                    if (contest.status == 'ACTIVE' && contest.rankings) {
                        for (var n = contest.rankings.length; n < contest.maxParticipants; n++) {
                            contest.rankings.push({
                                name: null,
                                rank: placeName(n + 1),
                                totalEquity: contest.startingBalance,
                                gainLoss: 0,
                                score: 0
                            });
                        }
                    }
                });
            }

            /**
             * Updates a participant with pricing information
             */
            function updateWithPricing(participant) {
                // retrieve the symbols
                var symbols = [];
                if (participant.positions) {
                    for (var n = 0; n < participant.positions.length; n++) {
                        symbols.push(participant.positions[n].symbol);
                    }
                }

                // load the symbols
                if (symbols.length) {
                    QuoteService.getPricing(symbols).then(function (response) {
                        var mapping = response.data;
                        for (var n = 0; n < participant.positions.length; n++) {
                            var pos = participant.positions[n];
                            var value = mapping[pos.symbol];
                            if (value != null) {
                                pos.lastTrade = value.lastTrade;
                                pos.netValue = pos.quantity * value.lastTrade;
                                pos.gainLoss = 100.0 * ((pos.netValue - pos.cost) / pos.cost);
                            }
                        }
                    });
                }
            }

            function loadEnrichedParticipant(contestId, playerName) {
                ContestService.getParticipantByName(contestId, playerName).then(function (response) {
                    // TODO console.log("BEFORE participant = " + JSON.stringify($scope.participant, null, '\t'));
                    // TODO console.log("AFTER participant = " + JSON.stringify(response.data, null, '\t'));
                    $scope.participant = response.data;
                });
            }

            $scope.tropy = function (place) {
                switch (place) {
                    case '1st':
                        return "contests/gold.png";
                    case '2nd':
                        return "contests/silver.png";
                    case '2nd':
                        return "contests/bronze.png";
                    default:
                        return "status/transparent.png";
                }
            }

            function placeName(n) {
                switch (n) {
                    case 1:
                        return "1st";
                    case 2:
                        return "2nd";
                    case 3:
                        return "3rd";
                    default:
                        return n + "th";
                }
            }

            function lookupParticipantByName(userName) {
                if ($scope.contest) {
                    var participants = $scope.contest.participants.filter(function (p) {
                        return p.name == userName;
                    });
                    return ( participants && participants.length > 0 ) ? participants[0] : {};
                }
                else return {};
            };

            $scope.contestSearch = function (searchOptions) {
                $scope.startLoading();
                $scope.message = "";

                ContestService.findContests(searchOptions).then(
                    function (contests) {
                        $scope.searchResults = contests;
                        if (contests.length) {
                            // make sure the contest ID is set
                            var contestId = contests[0]._id.$oid;
                            if (( !$scope.contestId || $scope.contestId == "" ) && ($scope.contestId != contestId)) {
                                $scope.contestId = contestId;
                            }

                            // load the rankings for the current player or leader
                            var playerName = MySession.userProfile.name;
                            if (playerName != 'Spectator') {
                                loadPlayerRankings(contests, playerName);
                            }
                            else {
                                loadLeaderRankings(contests);
                            }
                        }
                        $scope.stopLoading();
                    },
                    function (err) {
                        $scope.message = "Failed to execute Contest Search";
                        $scope.stopLoading();
                    });
            };

            function loadPlayerRankings(contests, playerName) {
                for (var n = 0; n < contests.length; n++) {
                    var contest = contests[n];

                    // is the player in the contest?
                    if (containsPlayer(contest.participants, playerName)) {
                        ContestService.getRankingsWithCallback(contest, function (contest) {
                            contest.leader = findPlayerByName(contest.rankings, playerName);
                        });
                    }
                }
            }

            function loadLeaderRankings(contests) {
                for (var n = 0; n < contests.length; n++) {
                    var contest = contests[n];
                    ContestService.getRankingsWithCallback(contest, function (contest) {
                        contest.leader = contest.rankings[0];
                    });
                }
            }

            $scope.getMyContests = function (searchTerm) {
                var term = searchTerm.toLowerCase();
                if (!term || term == "") return $scope.myContests;
                else {
                    return $scope.myContests.filter(function (c) {
                        return c.name.toLowerCase().indexOf(term) != -1;
                    });
                }
            };

            $scope.loadMyContests = function (playerId) {
                if (playerId) {
                    $scope.startLoading();
                    $scope.message = "";
                    ContestService.getMyContests(playerId)
                        .success(function (contests) {
                            $scope.myContests = contests;
                            if (contests.length > 0 && $scope.contestId == "") {
                                $scope.contestId = contests[0]._id.$oid;
                                MySession.contestId = $scope.contestId;
                            }
                            $scope.stopLoading();
                        })
                        .error(function (err) {
                            $scope.message = "Failed to load My Contests";
                            $scope.stopLoading();
                        });
                }
            };

            $scope.tradingStart = function () {
                return (new Date()).getTime(); // TODO replace with service call
            };

            $scope.isMarketOrder = function (order) {
                return order.priceType == 'MARKET' || order.priceType == 'MARKET_ON_CLOSE';
            };

            // define the levels
            $scope.levels = [
                {"number": 1, "nextLevelXP": 1000, "description": "Private"},
                {"number": 2, "nextLevelXP": 2000, "description": "Private 1st Class"},
                {"number": 3, "nextLevelXP": 4000, "description": "Corporal"},
                {"number": 4, "nextLevelXP": 8000, "description": "First Corporal"},
                {"number": 5, "nextLevelXP": 16000, "description": "Sergeant"},
                {"number": 6, "nextLevelXP": 32000, "description": "Staff Sergeant"},
                {"number": 7, "nextLevelXP": 64000, "description": "Gunnery Sergeant"},
                {"number": 8, "nextLevelXP": 1280000, "description": "Master Sergeant"},
                {"number": 9, "nextLevelXP": 256000, "description": "First Sergeant"},
                {"number": 10, "nextLevelXP": 1024000, "description": "Sergeant Major"},
                {"number": 11, "nextLevelXP": 2048000, "description": "Warrant Officer 3rd Class"},
                {"number": 12, "nextLevelXP": 4096000, "description": "Warrant Officer 2nd Class"},
                {"number": 13, "nextLevelXP": 4096000, "description": "Warrant Officer 1st Class"},
                {"number": 14, "nextLevelXP": 8192000, "description": "Chief Warrant Officer"},
                {"number": 15, "nextLevelXP": 8192000, "description": "Master Chief Warrant Officer"},
                {"number": 16, "nextLevelXP": 16384000, "description": "Lieutenant"},
                {"number": 17, "nextLevelXP": 32768000, "description": "First Lieutenant"},
                {"number": 18, "nextLevelXP": 65536000, "description": "Captain"},
                {"number": 19, "nextLevelXP": 131072000, "description": "Major"},
                {"number": 20, "nextLevelXP": 262144000, "description": "Lieutenant Colonel"},
                {"number": 21, "nextLevelXP": 524288000, "description": "Colonel"},
                {"number": 22, "nextLevelXP": 524288000, "description": "Brigadier General"},
                {"number": 23, "nextLevelXP": 524288000, "description": "Major General"},
                {"number": 24, "nextLevelXP": 524288000, "description": "Lieutenant General"},
                {"number": 25, "nextLevelXP": 524288000, "description": "General"}];

            // watch the contest ID
            $scope.$watch("contestId", function (oldVal, newVal) {
                // load the contest
                $scope.loadContest($scope.contestId);
            });

            $scope.$watch("searchOptions", function () {
                $scope.contestSearch($scope.searchOptions);
            }, true);

            // watch for changes to the player's profile
            $scope.$watch("MySession.userProfile", function (oldVal, newVal) {
                $scope.contestId = MySession.contestId;

                var playerName = MySession.userProfile.name
                if (playerName != 'Spectator') {
                    // load the player's games
                    $scope.loadMyContests(MySession.userProfile._id.$oid);

                    // load the contest
                    $scope.loadContest($scope.contestId);
                }
            });

        }]);